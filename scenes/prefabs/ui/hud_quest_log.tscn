[gd_scene load_steps=3 format=3 uid="uid://bfvfi2nwpg7lv"]

[ext_resource type="Texture2D" uid="uid://cvqiwepgya3ua" path="res://icon.svg" id="1_84b1v"]

[sub_resource type="GDScript" id="GDScript_84b1v"]
script/source = "extends Widget

@onready var quest_list_parent: Container = %quest_list_parent
@onready var quest_list_prefab: VBoxContainer = %quest_list_prefab
@onready var quest_button_prefab: Container = %quest_button_prefab
@onready var quest_info: RichTextLabel = %quest_info
@onready var tick_prefab: Control = %tick_prefab
@onready var tick_parent: Control = %tick_parent
var quest: QuestInfo

func _ready() -> void:
	quest_button_prefab.get_parent().remove_child(quest_button_prefab)
	quest_list_parent.remove_child(quest_list_prefab)
	tick_parent.remove_child(tick_prefab)
	
	await get_tree().process_frame
	
	for q: QuestInfo in State.quests:
		q.changed.connect(_refresh)
		for tick_id in q.ticks:
			q.ticks[tick_id].changed.connect(_refresh)
	
	_refresh()
	_select_quest(State.quests._objects.values()[0])

func is_game_pauser() -> bool: return true
func is_cursor_used() -> bool: return true

func _refresh():
	_refresh_quest_list()
	_refresh_quest_info()

func _refresh_quest_list():
	var quest_lists := {}
	
	for child in quest_list_parent.get_children():
		quest_list_parent.remove_child(child)
		child.queue_free()
	
	for q: QuestInfo in State.quests:
		var state: StringName = QuestInfo.QuestState.keys()[q.state]
		if not state in quest_lists:
			var list := quest_list_prefab.duplicate()
			quest_list_parent.add_child(list)
			list.get_node(\"label\").text = state
			quest_lists[state] = list
		
		var quest_button: Node = quest_button_prefab.duplicate()
		quest_lists[state].get_node(\"list\").add_child(quest_button)
		#btn.quest = q
		var btn := quest_button.get_node(\"button\")
		btn.name = q.id
		btn.text = q.name
		btn.modulate = QuestInfo.get_state_color(q.state)
		btn.pressed.connect(_select_quest.bind(q))

func _refresh_quest_info():
	UNode.remove_children(tick_parent)
	
	if quest:
		quest_info.text = \"%s\\n[i]%s\" % [quest.name, quest.desc]
		
		for tick_id: StringName in quest.ticks:
			var tick := quest.ticks[tick_id]
			var tk := tick_prefab.duplicate()
			tick_parent.add_child(tk)
			tk.text = \"%s/%s %s\" % [tick.tick, tick.max_ticks, tick.name]
	else:
		quest_info.text = \"\"

func _select_quest(q: QuestInfo):
	quest = q
	_refresh_quest_info()

#func _descend(quest: Quest):
	#for goal in quest:
		#quest_info.text += \"\\t[i]%s[/i]: [i]%s[/i]\\n\" % [goal.name, goal.desc]
		#_descend(goal)
"

[node name="hud_quest_log" type="Control"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
script = SubResource("GDScript_84b1v")

[node name="HBoxContainer" type="HBoxContainer" parent="."]
layout_mode = 0
offset_right = 40.0
offset_bottom = 40.0

[node name="PanelContainer" type="PanelContainer" parent="HBoxContainer"]
layout_mode = 2

[node name="MarginContainer" type="MarginContainer" parent="HBoxContainer/PanelContainer"]
layout_mode = 2
theme_override_constants/margin_left = 8
theme_override_constants/margin_top = 8
theme_override_constants/margin_right = 8
theme_override_constants/margin_bottom = 8

[node name="quest_list_parent" type="VBoxContainer" parent="HBoxContainer/PanelContainer/MarginContainer"]
unique_name_in_owner = true
layout_mode = 2

[node name="quest_list_prefab" type="VBoxContainer" parent="HBoxContainer/PanelContainer/MarginContainer/quest_list_parent"]
unique_name_in_owner = true
layout_mode = 2

[node name="label" type="Label" parent="HBoxContainer/PanelContainer/MarginContainer/quest_list_parent/quest_list_prefab"]
layout_mode = 2
text = "Completed"

[node name="list" type="VBoxContainer" parent="HBoxContainer/PanelContainer/MarginContainer/quest_list_parent/quest_list_prefab"]
layout_mode = 2

[node name="quest_button_prefab" type="HBoxContainer" parent="HBoxContainer/PanelContainer/MarginContainer/quest_list_parent/quest_list_prefab/list"]
unique_name_in_owner = true
layout_mode = 2

[node name="icon" type="TextureRect" parent="HBoxContainer/PanelContainer/MarginContainer/quest_list_parent/quest_list_prefab/list/quest_button_prefab"]
layout_mode = 2
texture = ExtResource("1_84b1v")
expand_mode = 2
stretch_mode = 5

[node name="button" type="Button" parent="HBoxContainer/PanelContainer/MarginContainer/quest_list_parent/quest_list_prefab/list/quest_button_prefab"]
layout_mode = 2
text = "Quest 1"

[node name="Panel" type="PanelContainer" parent="HBoxContainer"]
layout_mode = 2

[node name="MarginContainer" type="MarginContainer" parent="HBoxContainer/Panel"]
layout_mode = 2
theme_override_constants/margin_left = 8
theme_override_constants/margin_top = 8
theme_override_constants/margin_right = 8
theme_override_constants/margin_bottom = 8

[node name="VBoxContainer" type="VBoxContainer" parent="HBoxContainer/Panel/MarginContainer"]
layout_mode = 2

[node name="quest_preview" type="TextureRect" parent="HBoxContainer/Panel/MarginContainer/VBoxContainer"]
layout_mode = 2
texture = ExtResource("1_84b1v")

[node name="quest_info" type="RichTextLabel" parent="HBoxContainer/Panel/MarginContainer/VBoxContainer"]
unique_name_in_owner = true
layout_mode = 2
bbcode_enabled = true
text = "Quest Description"
fit_content = true
autowrap_mode = 0

[node name="PanelContainer" type="PanelContainer" parent="HBoxContainer/Panel/MarginContainer/VBoxContainer"]
layout_mode = 2

[node name="MarginContainer" type="MarginContainer" parent="HBoxContainer/Panel/MarginContainer/VBoxContainer/PanelContainer"]
layout_mode = 2
theme_override_constants/margin_left = 8
theme_override_constants/margin_top = 8
theme_override_constants/margin_right = 8
theme_override_constants/margin_bottom = 8

[node name="tick_parent" type="VBoxContainer" parent="HBoxContainer/Panel/MarginContainer/VBoxContainer/PanelContainer/MarginContainer"]
unique_name_in_owner = true
layout_mode = 2

[node name="tick_prefab" type="Button" parent="HBoxContainer/Panel/MarginContainer/VBoxContainer/PanelContainer/MarginContainer/tick_parent"]
unique_name_in_owner = true
layout_mode = 2
text = "Quest Tick"
